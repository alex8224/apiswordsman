<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CodeSearcher</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 80%;
            margin-top: 20px;
        }
        .search-box {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-box .dropdown {
            position: relative;
            flex-grow: 1;
            margin-right: 10px;
        }
        .search-box .dropdown input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-box .dropdown .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1;
            width: 100%;
            margin-top: 2px;
        }
        .search-box .dropdown .dropdown-content label {
            display: block;
            padding: 8px;
            cursor: pointer;
        }
        .search-box .dropdown .dropdown-content label:hover {
            background-color: #f1f1f1;
        }
        .search-box .dropdown .dropdown-content input {
            margin-right: 10px;
        }
        .search-box input[type="text"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        .search-box button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }
        .search-box button:hover {
            background-color: #0056b3;
        }
        .search-results {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-result {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
        }
        .search-result pre {
            background: #272822;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 400px;
            counter-reset: linenumber;
        }
        .search-result pre code {
            position: relative;
            display: block;
        }
        .search-result pre code::before {
            counter-increment: linenumber;
            content: counter(linenumber);
            position: absolute;
            left: -2em;
            width: 2em;
            text-align: right;
            padding-right: 10px;
            border-right: 1px solid #ccc;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-box">
            <div class="dropdown">
                <input type="text" id="projectInput" placeholder="请选择项目" readonly onclick="toggleDropdown()" onblur="closeDropdown()">
                <div id="projectsDropdown" class="dropdown-content"></div>
            </div>
            <input type="text" id="keyword" placeholder="请输入关键字">
            <button onclick="searchCode()">搜索</button>
        </div>
        <div class="search-results">
            <h3>搜索结果:</h3>
            <div id="results"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-java.min.js"></script>
    <script>
        const token = 'Afkp4L1f-yAVYmpDqRjK';
        let selectedProjects = [];

        async function fetchProjects() {
            let startPage = 1;
            let hasMorePages = true;

            while (hasMorePages) {
                const projectsUrl = `http://172.26.0.18/api/v4/projects?page=${startPage}&per_page=100`;
                const response = await fetch('/http', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: projectsUrl, method: 'GET', req_headers: {"PRIVATE-TOKEN": token} })
                });
                const data = await response.json();
                const projects = data.resp;
				debugger;
                const nextPage = data.resp_header["X-Next-Page"];

                const dropdownContent = document.getElementById('projectsDropdown');
                projects.forEach(project => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.value = project.id;
                    input.onchange = updateSelectedProjects;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(project.name));
                    dropdownContent.appendChild(label);
                });

                if (!nextPage) {
                    hasMorePages = false;
                } else {
                    startPage = nextPage;
                }
            }
        }

        function toggleDropdown() {
            const dropdownContent = document.getElementById('projectsDropdown');
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        }

        function closeDropdown() {
            setTimeout(() => {
                const dropdownContent = document.getElementById('projectsDropdown');
                dropdownContent.style.display = 'none';
            }, 100); // Delay to allow checkbox click event
        }

        function updateSelectedProjects() {
            const projectInput = document.getElementById('projectInput');
            const dropdownContent = document.getElementById('projectsDropdown');
            const checkedInputs = dropdownContent.querySelectorAll('input:checked');
            selectedProjects = Array.from(checkedInputs).map(input => input.value);
            const selectedLabels = Array.from(checkedInputs).map(input => input.parentNode.textContent);
            projectInput.value = selectedLabels.join(', ');
        }

        async function searchCode() {
            const keyword = document.getElementById('keyword').value;
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            for (const projectId of selectedProjects) {
                const searchUrl = `http://172.26.0.18/api/v4/projects/${projectId}/search?scope=blobs&search=${keyword}&page=1&per_page=50`;
                const response = await fetch('/http', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: searchUrl, method: 'GET', req_headers: {"PRIVATE-TOKEN": token} })
                });
                const searchResults = await response.json();
                searchResults.resp.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.classList.add('search-result');

                    const filePath = document.createElement('div');
                    filePath.textContent = result.filename;
                    resultDiv.appendChild(filePath);

                    const codeBlock = document.createElement('pre');
                    codeBlock.classList.add('language-java');
                    codeBlock.dataset.startline = result.startline || 1;
                    codeBlock.innerHTML = `<code class="language-java">${result.data}</code>`;
                    resultDiv.appendChild(codeBlock);

                    resultsContainer.appendChild(resultDiv);
                    addLineNumbers(codeBlock);
                    Prism.highlightElement(codeBlock.querySelector('code'));
                });
            }
        }

        function addLineNumbers(preElement) {
            const startLine = parseInt(preElement.dataset.startline, 10);
            const codeLines = preElement.querySelector('code').innerHTML.split('\n');
            preElement.querySelector('code').innerHTML = codeLines.map((line, index) => {
                return `<span class="line-number" data-line-number="${startLine + index}">${line}</span>`;
            }).join('\n');
        }

        document.addEventListener('DOMContentLoaded', fetchProjects);
    </script>
</body>
</html>
